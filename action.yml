name: 'Report test coverage'
description: 'Run tests and report the test coverage'

branding:
  icon: 'file-text'
  color: 'green'

inputs:

  run:
    description: 'Commands to run the test suite and compute the test coverage (only for the `pull_requrst` and `push` triggers).'
    default: |
      coverage run -m unittest discover \$GROUP
      python -m coverage json --omit "tests/*"
      mv "coverage.json" "coverage-\$GROUP.json"

  working-directory:
    description: 'Directory in which the test suite will be run (only for the `pull_requrst` and `push` triggers).'
    default: '.'

  report:
    description: 'Report the test coverage.'
    default: 'true'

  gist-id:
    description: 'Gist ID where to store the coverage results (only for the `pull_requrst` and `push` triggers).'
    required: 'true'

  gist-auth:
    description: 'Authentication token used to update the gist (only for the `pull_requrst` and `push` triggers).'
    required: 'true'

  gist-filename:
    description: 'Filename to assign to the gist (only for the `pull_requrst` and `push` triggers).'
    default: coverage.json

  main-group:
    description: 'The test group to report in the badge (must be one out of `unit`, `module`, `integration`).'
    default: 'unit'

  badge-label:
    description: 'The label of the badge.'
    default: 'Unit Test Coverage'

outputs:

  coverage:
    description: 'The test coverage (value between 0 and 100, only for the `pull_requrst` and `push` triggers).'
    value: ${{ steps.coverage.outputs.coverage }}

runs:

  using: "composite"
  steps:

    - name: Install dependencies
      if: github.event_name == 'pull_request' || github.event_name == 'push'
      shell: bash
      run: |
        sudo apt install -y jq
        pip install coverage

    - name: Run test suite
      if: github.event_name == 'pull_request' || github.event_name == 'push'
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      run: |
        for group in "unit" "module" "integration"; do
          export GROUP="$group"
          ${{ inputs.run }}
        done

    - name: Fetch coverage
      if: inputs.report == 'true' && (github.event_name == 'pull_request' || github.event_name == 'push')
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      run: |
        for group in "unit" "module" "integration"; do
          echo "coverage_$group=$(jq -r '[.totals.percent_covered_display][0]' coverage-$group.json)" >> $GITHUB_ENV
        done
  
    - name: Prepare a comment for the pull request
      if: inputs.report == 'true' && github.event_name == 'pull_request'
      shell: bash
      run: |
        echo "{
          \"issue_number\": $ISSUE_NUMBER,
          \"body\": \"Test coverage results for $HEAD_SHA:\n- Unit tests: **$coverage_unit%**\n- Module tests: **$coverage_module%**\n- Integration tests: **$coverage_integration%**\"
        }" >> comment.json
      env:
        ISSUE_NUMBER: ${{ github.event.number }}
        HEAD_SHA: ${{ github.event.pull_request.head.sha }}

    - name: Upload the comment as an artifact
      if: inputs.report == 'true' && github.event_name == 'pull_request'
      uses: actions/upload-artifact@v4
      with:
        name: comment
        path: comment.json

    - name: Create badge
      if: inputs.report == 'true' && github.event_name == 'push'
      uses: schneegans/dynamic-badges-action@v1.7.0
      with:
        auth: ${{ inputs.gist-auth }}
        gistID: ${{ inputs.gist-id }}
        filename: ${{ inputs.gist-filename }}
        label: ${{ inputs.badge-label }}
        message: ${{ env.${{ inputs.main-group }}_coverage }}%
        minColorRange: 50
        maxColorRange: 90
        valColorRange: ${{ env.${{ inputs.main-group }}_coverage }}
